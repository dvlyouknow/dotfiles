#!/bin/bash

set -eou pipefail

EMAIL="$1"

PIPEDIR=$(mktemp -d)
PIPEFILE="$PIPEDIR/pipe"

trap 'rm -rf "$PIPEDIR"' exit

mkfifo "$PIPEFILE"

sdm login --email "$EMAIL" &> "$PIPEFILE" &

SDMPID="$!"
read OUTPUT < "$PIPEFILE"

URL=${OUTPUT/#"Please complete logging in at: "}

firefox -new-tab "$URL"

while ps -p "$SDMPID" &> /dev/null;
do
    echo "...waiting for login to complete"
    sleep 1;
done

# vi: ft=bash
